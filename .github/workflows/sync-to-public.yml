name: Sync to Public Repository

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
    types: [ closed ]

jobs:
  sync:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    
    steps:
      - name: Checkout private repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

      - name: Clone public repository
        run: |
          git clone https://${{ secrets.PUBLIC_REPO_TOKEN }}@github.com/INI-K/CamCon_Pub.git public_repo
          cd public_repo
          git remote add private ${{ github.server_url }}/${{ github.repository }}.git

      - name: Sync files from private to public
        run: |
          cd public_repo
          
          # í˜„ìž¬ í¼ë¸”ë¦­ ë ˆí¬ì§€í† ë¦¬ì˜ main ë¸Œëžœì¹˜ë¥¼ í™•ì¸
          git checkout main || git checkout -b main
          
          # í”„ë¼ì´ë¹— ë ˆí¬ì§€í† ë¦¬ì˜ ë³€ê²½ì‚¬í•­ì„ ìž„ì‹œ ë¸Œëžœì¹˜ë¡œ ê°€ì ¸ì˜¤ê¸°
          git remote set-url private https://${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          git fetch private
          
          # í”„ë¼ì´ë¹— ë ˆí¬ì§€í† ë¦¬ì˜ íŒŒì¼ë“¤ì„ ë³µì‚¬ (ì œì™¸ íŒŒì¼ë“¤ ë¹¼ê³ )
          git checkout private/${{ github.ref_name }} -- . || git checkout private/main -- .
          
          # ì œì™¸í•  íŒŒì¼ë“¤ê³¼ ë””ë ‰í† ë¦¬ë“¤ ì‚­ì œ
          rm -rf app/src/main/cpp/ || true
          rm -rf app/src/main/jniLibs/ || true
          rm -rf Complete_arm64-v8a/ || true
          rm -rf Key/ || true
          rm -f key.properties || true
          rm -f app/google-services.json || true
          rm -f local.properties || true
          rm -f build_libgphoto2.sh || true
          rm -rf app/release/ || true
          rm -f *.log || true
          rm -f kapt_error.log || true
          rm -f build.log || true
          
          # .gitignore íŒŒì¼ ìƒì„±/ì—…ë°ì´íŠ¸
          cat > .gitignore << 'EOF'
          # ë„¤ì´í‹°ë¸Œ ì½”ë“œ ì œì™¸
          app/src/main/cpp/
          app/src/main/jniLibs/
          Complete_arm64-v8a/
          
          # ë“œë¼ì´ë²„ ë° ë„¤ì´í‹°ë¸Œ ë¼ì´ë¸ŒëŸ¬ë¦¬ íŒŒì¼ë“¤ ì œì™¸
          *.so
          *.so.*
          *.a
          *.la
          
          # ë¹Œë“œ ìŠ¤í¬ë¦½íŠ¸ ì œì™¸
          build_libgphoto2.sh
          
          # í‚¤ íŒŒì¼ë“¤ ì œì™¸ (ë³´ì•ˆ)
          Key/
          key.properties
          app/google-services.json
          local.properties
          
          # ë¹Œë“œ ê²°ê³¼ë¬¼ ë° ë¡œê·¸
          app/release/
          *.log
          kapt_error.log
          build.log
          
          # IDE íŒŒì¼ë“¤
          .idea/
          *.iml
          
          # Android ë¹Œë“œ íŒŒì¼ë“¤
          .gradle/
          build/
          captures/
          .externalNativeBuild/
          .cxx/
          EOF

      - name: Create README for public repository
        run: |
          cd public_repo
          
          # í¼ë¸”ë¦­ ë²„ì „ìš© README ìƒì„±
          cat > README_PUBLIC.md << 'EOF'
          # CamCon - í¼ë¸”ë¦­ ë²„ì „
          
          ì´ ë ˆí¬ì§€í† ë¦¬ëŠ” CamCon í”„ë¡œì íŠ¸ì˜ í¼ë¸”ë¦­ ë²„ì „ìž…ë‹ˆë‹¤.
          
          ## âš ï¸ ì£¼ì˜ì‚¬í•­
          - ì´ ë²„ì „ì—ëŠ” ë„¤ì´í‹°ë¸Œ ì½”ë“œì™€ ë“œë¼ì´ë²„ íŒŒì¼ì´ ì œì™¸ë˜ì–´ ìžˆìŠµë‹ˆë‹¤
          - ì™„ì „í•œ ë¹Œë“œë¥¼ ìœ„í•´ì„œëŠ” ë³„ë„ì˜ ë„¤ì´í‹°ë¸Œ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ í•„ìš”í•©ë‹ˆë‹¤
          - ìžë™ìœ¼ë¡œ í”„ë¼ì´ë¹— ë ˆí¬ì§€í† ë¦¬ì™€ ë™ê¸°í™”ë©ë‹ˆë‹¤
          
          ## ðŸš« ì œì™¸ëœ íŒŒì¼ë“¤
          - `app/src/main/cpp/`: C++ ë„¤ì´í‹°ë¸Œ ì½”ë“œ
          - `app/src/main/jniLibs/`: JNI ë¼ì´ë¸ŒëŸ¬ë¦¬ íŒŒì¼ë“¤
          - `Complete_arm64-v8a/`: ARM64 ë¼ì´ë¸ŒëŸ¬ë¦¬
          - `Key/`: í‚¤ íŒŒì¼ë“¤ (ë³´ì•ˆ)
          - ë“œë¼ì´ë²„ ê´€ë ¨ ìŠ¤í¬ë¦½íŠ¸ ë° ì„¤ì • íŒŒì¼ë“¤
          - ë¹Œë“œ ê²°ê³¼ë¬¼ ë° ë¡œê·¸ íŒŒì¼ë“¤
          
          ## ðŸ“ í¬í•¨ëœ íŒŒì¼ë“¤
          - Android ì• í”Œë¦¬ì¼€ì´ì…˜ ì†ŒìŠ¤ì½”ë“œ (Java/Kotlin)
          - UI ë¦¬ì†ŒìŠ¤ ë° ë ˆì´ì•„ì›ƒ
          - ì„¤ì • íŒŒì¼ë“¤ (ë¯¼ê°í•˜ì§€ ì•Šì€ íŒŒì¼ë“¤ë§Œ)
          - ë¬¸ì„œ ë° README
          
          ## ðŸ”„ ë™ê¸°í™” ì •ë³´
          - ìžë™ ë™ê¸°í™”: main, develop ë¸Œëžœì¹˜ í‘¸ì‹œ ì‹œ
          - ë§ˆì§€ë§‰ ë™ê¸°í™”: $(date '+%Y-%m-%d %H:%M:%S UTC')
          - ì›ë³¸ ë ˆí¬ì§€í† ë¦¬: í”„ë¼ì´ë¹— ì €ìž¥ì†Œì—ì„œ ê´€ë¦¬
          
          ## ðŸ“ ë¼ì´ì„ ìŠ¤
          ì›ë³¸ í”„ë¡œì íŠ¸ì˜ ë¼ì´ì„ ìŠ¤ë¥¼ ë”°ë¦…ë‹ˆë‹¤.
          EOF
          
          # ê¸°ì¡´ READMEê°€ ìžˆë‹¤ë©´ ë°±ì—…
          if [ -f README.md ] && ! grep -q "í¼ë¸”ë¦­ ë²„ì „" README.md; then
            mv README.md README_ORIGINAL.md
          fi
          mv README_PUBLIC.md README.md

      - name: Commit and push changes
        run: |
          cd public_repo
          
          # ë³€ê²½ì‚¬í•­ì´ ìžˆëŠ”ì§€ í™•ì¸
          git add .
          
          if [ -n "$(git status --porcelain)" ]; then
            # ì»¤ë°‹ ë©”ì‹œì§€ ìƒì„±
            COMMIT_MSG="Sync from private repository
          
            - ë™ê¸°í™” ë‚ ì§œ: $(date '+%Y-%m-%d %H:%M:%S UTC')
            - ì†ŒìŠ¤ ë¸Œëžœì¹˜: ${{ github.ref_name }}
            - ì»¤ë°‹ SHA: ${{ github.sha }}
            - ì œì™¸ëœ íŒŒì¼: ë„¤ì´í‹°ë¸Œ ì½”ë“œ, ë“œë¼ì´ë²„, ë¯¼ê°í•œ ì„¤ì • íŒŒì¼ë“¤"
          
            git commit -m "$COMMIT_MSG"
          
            # í¼ë¸”ë¦­ ë ˆí¬ì§€í† ë¦¬ì— í‘¸ì‹œ
            git push origin main
          
            echo "âœ… í¼ë¸”ë¦­ ë ˆí¬ì§€í† ë¦¬ ë™ê¸°í™” ì™„ë£Œ"
          else
            echo "â„¹ï¸ ë™ê¸°í™”í•  ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤"
          fi

      - name: Create or update sync status
        run: |
          cd public_repo
          
          # ë™ê¸°í™” ìƒíƒœ íŒŒì¼ ìƒì„±
          mkdir -p .github
          cat > .github/SYNC_STATUS.md << EOF
          # ë™ê¸°í™” ìƒíƒœ
          
          ## ë§ˆì§€ë§‰ ë™ê¸°í™” ì •ë³´
          - **ë‚ ì§œ**: $(date '+%Y-%m-%d %H:%M:%S UTC')
          - **ì†ŒìŠ¤ ë¸Œëžœì¹˜**: ${{ github.ref_name }}
          - **ì»¤ë°‹ SHA**: ${{ github.sha }}
          - **ì›Œí¬í”Œë¡œ**: ${{ github.workflow }}
          - **ì‹¤í–‰ ë²ˆí˜¸**: ${{ github.run_number }}
          
          ## ì œì™¸ëœ í•­ëª©ë“¤
          - ë„¤ì´í‹°ë¸Œ C++ ì½”ë“œ (`app/src/main/cpp/`)
          - JNI ë¼ì´ë¸ŒëŸ¬ë¦¬ë“¤ (`app/src/main/jniLibs/`)
          - ARM64 ë¼ì´ë¸ŒëŸ¬ë¦¬ (`Complete_arm64-v8a/`)
          - ë³´ì•ˆ í‚¤ íŒŒì¼ë“¤ (`Key/`, `key.properties` ë“±)
          - ë¹Œë“œ ê²°ê³¼ë¬¼ ë° ë¡œê·¸
          
          ## ë™ê¸°í™” ê·œì¹™
          - main ë¸Œëžœì¹˜ í‘¸ì‹œ ì‹œ ìžë™ ë™ê¸°í™”
          - develop ë¸Œëžœì¹˜ í‘¸ì‹œ ì‹œ ìžë™ ë™ê¸°í™”
          - Pull Requestê°€ mainì— ë¨¸ì§€ë  ë•Œ ë™ê¸°í™”
          
          ---
          *ì´ íŒŒì¼ì€ ìžë™ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤.*
          EOF
          
          git add .github/SYNC_STATUS.md
          git commit -m "Update sync status - $(date '+%Y-%m-%d %H:%M:%S')" || true
          git push origin main || true